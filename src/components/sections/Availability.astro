---
import { MONTH_NAMES, DAY_NAMES } from "../../utils/calendar.js";

interface Props {
  t: any;
  locale: string;
}
const { t, locale } = Astro.props as Props;

// Pass data to client-side script
const calendarData = {
  locale,
  monthNames: MONTH_NAMES,
  dayNames: DAY_NAMES,
};
---

<section
  id="availability"
  class="py-20 bg-gradient-to-br from-sage-50 via-warm-50 to-earth-50 relative overflow-hidden"
>
  <!-- Background decoration -->
  <div
    class="absolute top-0 right-0 w-96 h-96 bg-sage-300/20 rounded-full blur-3xl"
  >
  </div>
  <div
    class="absolute bottom-0 left-0 w-80 h-80 bg-warm-300/20 rounded-full blur-3xl"
  >
  </div>

  <div class="max-w-4xl mx-auto px-4 relative z-10">
    <div class="text-center mb-12">
      <h2 class="text-4xl font-serif font-bold text-earth-800 mb-4">
        {t.calendar.title}
      </h2>
      <p class="text-lg text-earth-700">
        {t.calendar.subtitle}
      </p>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6">
      <!-- Loading State -->
      <div
        id="calendar-loading"
        class="flex flex-col items-center justify-center"
        style="min-height: 463px;"
      >
        <div class="relative w-16 h-16 mb-4">
          <div class="absolute inset-0 border-4 border-sage-200 rounded-full">
          </div>
          <div
            class="absolute inset-0 border-4 border-sage-600 rounded-full border-t-transparent animate-spin"
          >
          </div>
        </div>
        <p class="text-earth-600 text-lg">
          {
            locale === "fr"
              ? "Chargement du calendrier..."
              : "Loading calendar..."
          }
        </p>
      </div>

      <!-- Calendar Grid -->
      <div id="calendar-grid" class="hidden md:grid-cols-2 gap-8">
        <!-- Will be populated by JavaScript -->
      </div>

      <!-- Legend -->
      <div
        id="calendar-legend"
        class="hidden justify-center mt-6 gap-6 text-sm"
      >
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-sage-100 rounded"></div>
          <span class="text-earth-700">
            {locale === "fr" ? "Disponible" : "Available"}
          </span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-red-100 rounded"></div>
          <span class="text-earth-700">
            {locale === "fr" ? "Réservé" : "Booked"}
          </span>
        </div>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ calendarData }}>
  // Dynamic calendar with month navigation
  class AvailabilityCalendar {
    constructor(data) {
      this.bookedDates = [];
      this.locale = data.locale;
      this.monthNames = data.monthNames;
      this.dayNames = data.dayNames;
      this.selectedDates = new Set();
      this.isLoading = true;

      const today = new Date();
      this.currentYear = today.getFullYear();
      this.currentMonth = today.getMonth();

      this.init();
    }

    async init() {
      await this.fetchCalendarData();
      this.render();
      this.setupNavigation();
      this.hideLoading();
    }

    async fetchCalendarData() {
      try {
        // Add timestamp to prevent caching
        const timestamp = Date.now();
        const response = await fetch(`/api/calendar?_t=${timestamp}`, {
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache'
          }
        });
        const data = await response.json();
        this.bookedDates = data.bookedDates || [];
      } catch (error) {
        console.error("Error fetching calendar data:", error);
        this.bookedDates = [];
      }
    }

    hideLoading() {
      const loading = document.getElementById("calendar-loading");
      const grid = document.getElementById("calendar-grid");
      const legend = document.getElementById("calendar-legend");

      if (loading) loading.classList.add("hidden");
      if (grid) {
        grid.classList.remove("hidden");
        grid.classList.add("grid");
      }
      if (legend) {
        legend.classList.remove("hidden");
        legend.classList.add("flex");
      }
    }

    setupNavigation() {
      // Navigation will be set up after render with inline buttons
    }

    navigatePrev() {
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();

      // Don't go back before current month
      if (
        this.currentYear === currentYear &&
        this.currentMonth === currentMonth
      ) {
        return;
      }

      this.currentMonth--;
      if (this.currentMonth < 0) {
        this.currentMonth = 11;
        this.currentYear--;
      }
      this.render();
    }

    navigateNext() {
      this.currentMonth++;
      if (this.currentMonth > 11) {
        this.currentMonth = 0;
        this.currentYear++;
      }
      this.render();
    }

    generateCalendarData(year, month) {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      const calendarDays = [];

      // Add empty cells for days before month starts
      for (let i = 0; i < startingDayOfWeek; i++) {
        calendarDays.push({ day: null, isBooked: false, isPast: false });
      }

      // Add days of the month
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateString = date.toISOString().split("T")[0];
        const isPast = date < today;
        const isBooked = this.bookedDates.includes(dateString);

        calendarDays.push({
          day,
          date: dateString,
          isBooked,
          isPast,
          isAvailable: !isBooked && !isPast,
        });
      }

      return {
        year,
        month,
        days: calendarDays,
      };
    }

    renderMonth(monthData, isFirst) {
      const daysHtml = monthData.days
        .map(({ day, isBooked, isPast, isAvailable }) => {
          if (!day) return "<div></div>";

          let classes =
            "aspect-square flex items-center justify-center text-sm rounded-md ";

          if (isPast) {
            classes += "text-earth-300";
          } else if (isBooked) {
            classes += "bg-red-100 text-red-700";
          } else if (isAvailable) {
            classes += "bg-sage-100 text-sage-700";
          } else {
            classes += "text-earth-400";
          }

          return `<div class="${classes}">${day}</div>`;
        })
        .join("");

      const dayHeaders = this.dayNames[this.locale]
        .map(
          (day) =>
            `<div class="text-center font-medium text-earth-600 py-2">${day}</div>`
        )
        .join("");

      // Check if we're at the current month
      const today = new Date();
      const isCurrentMonth =
        this.currentYear === today.getFullYear() &&
        this.currentMonth === today.getMonth();

      const prevButton = isFirst
        ? isCurrentMonth
          ? '<div class="w-7"></div>'
          : `<button 
            onclick="window.availabilityCalendar.navigatePrev()"
            class="p-1 hover:bg-sage-50 rounded transition-all duration-200"
            aria-label="${this.locale === "fr" ? "Mois précédent" : "Previous month"}"
          >
            <svg class="w-5 h-5 text-sage-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>`
        : '<div class="w-7"></div>';

      const nextButton = !isFirst
        ? `
        <button 
          onclick="window.availabilityCalendar.navigateNext()"
          class="p-1 hover:bg-sage-50 rounded transition-all duration-200"
          aria-label="${this.locale === "fr" ? "Mois suivant" : "Next month"}"
        >
          <svg class="w-5 h-5 text-sage-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      `
        : '<div class="w-7"></div>';

      return `
        <div>
          <div class="flex items-center justify-between mb-4">
            ${prevButton}
            <h3 class="text-xl font-semibold text-earth-800">
              ${this.monthNames[this.locale][monthData.month]} ${monthData.year}
            </h3>
            ${nextButton}
          </div>
          <div class="grid grid-cols-7 gap-1 text-sm">
            ${dayHeaders}
            ${daysHtml}
          </div>
        </div>
      `;
    }

    render() {
      const month1 = this.generateCalendarData(
        this.currentYear,
        this.currentMonth
      );
      const month2 = this.generateCalendarData(
        this.currentMonth === 11 ? this.currentYear + 1 : this.currentYear,
        this.currentMonth === 11 ? 0 : this.currentMonth + 1
      );

      const grid = document.getElementById("calendar-grid");
      if (grid) {
        grid.innerHTML =
          this.renderMonth(month1, true) + this.renderMonth(month2, false);
      }
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    window.availabilityCalendar = new AvailabilityCalendar(calendarData);
  });
</script>
